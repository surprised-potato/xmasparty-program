<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>UNO-R Master Digital Script 2025</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <style>
        :root {
            --unor-blue: #002D62;
            --unor-gold: #FFD700;
            --text-white: #ffffff;
            --bg-dark: #001a35;
            --vo-gray: #34495e;
            --festive-green: #27ae60;
        }
        .seq-num-top {
            position: absolute;
            top: 20px;
            left: 20px;
            font-size: 0.9rem;
            font-weight: 900;
            color: var(--unor-gold);
            background: rgba(0, 0, 0, 0.3);
            padding: 5px 12px;
            border-radius: 5px;
            letter-spacing: 2px;
        }

        * { box-sizing: border-box; }
        body, html { margin: 0; padding: 0; height: 100%; width: 100%; overflow: hidden; font-family: 'Montserrat', sans-serif; background-color: var(--bg-dark); }

        /* Progress Bar */
        /* Find this in your CSS and change top to bottom */
        .progress-nav { 
            position: fixed; 
            bottom: 0;      /* Changed from top: 0 */
            left: 0; 
            width: 100%; 
            height: 8px; 
            background: rgba(255,255,255,0.1); 
            z-index: 1000; 
        }
        
        .progress-bar { 
            height: 100%; 
            background: #FFD700; /* Gold Color */
            width: 0%;           /* Start at zero */
            transition: width 0.2s ease-out; 
            box-shadow: 0 0 10px #FFD700; 
        }

        /* Nav Arrows */
        .nav-arrow { position: fixed; top: 50%; transform: translateY(-50%); background: rgba(255, 215, 0, 0.2); color: var(--unor-gold); border: 2px solid var(--unor-gold); padding: 15px; border-radius: 50%; cursor: pointer; z-index: 1001; font-size: 1.5rem; width: 55px; height: 55px; display: flex; align-items: center; justify-content: center; }
        .prev { left: 15px; } .next { right: 15px; }

        /* Swipe Container */
        /* Update this section */
        .slider { 
            display: flex; 
            overflow-x: auto; 
            overflow-y: hidden; /* Prevents container from wobbling vertically */
            scroll-snap-type: x mandatory; 
            scroll-behavior: smooth; 
            height: 100dvh; /* Uses Dynamic Height to account for mobile bars */
            width: 100vw; 
            -webkit-overflow-scrolling: touch; 
        }
        .slider::-webkit-scrollbar { display: none; }

        /* Slide Cards */
        /* Update this section */
        .slide { 
            flex: 0 0 100vw; 
            width: 100vw; 
            height: 100dvh; /* Fixes "not scrolling all the way" on mobile */
            scroll-snap-align: start; 
            scroll-snap-stop: always; /* FIX: Only swipes ONE card at a time */
            
            padding: 60px 40px 200px 40px; /* Added 100px bottom padding buffer */
            display: flex; 
            flex-direction: column; 
            justify-content: flex-start; 
            position: relative; 
            overflow-y: auto; /* Allows vertical scrolling for long scripts */
            -webkit-overflow-scrolling: touch;
        }
        .header { margin-bottom: 20px; border-bottom: 3px solid var(--unor-gold); padding-bottom: 10px; }
        .header h2 { font-family: 'Playfair Display', serif; color: var(--unor-gold); margin: 0; font-size: 1.8rem; text-transform: uppercase; }
        .header p { color: #bdc3c7; font-size: 0.9rem; margin: 5px 0; font-weight: 700; letter-spacing: 1px; }

        .section { background: rgba(255,255,255,0.07); margin: 10px 0; padding: 20px; border-radius: 15px; border-left: 5px solid transparent; }
        .label { font-size: 0.75rem; font-weight: 800; text-transform: uppercase; margin-bottom: 8px; display: block; letter-spacing: 1.5px; }
        
        .bridge-section { border-left-color: #e67e22; }
        .intro-section { border-left-color: #3498db; }
        .thank-section { border-left-color: var(--festive-green); }

        .content { font-size: 1.15rem; line-height: 1.6; color: var(--text-white); }
        .bridge-text { font-style: italic; color: #e67e22; }
        .thank-text { font-weight: 700; color: var(--festive-green); }
        .dept-list { font-size: 0.85rem; color: #ecf0f1; margin-top: 10px; padding: 10px; background: rgba(0,0,0,0.2); border-radius: 8px; font-weight: 400; display: block; }
        
        .vo-badge { background: #c0392b; color: white; padding: 4px 10px; border-radius: 5px; font-size: 0.7rem; margin-right: 10px; vertical-align: middle; }
        .seq-num { position: absolute; top: 65px; right: 80px; font-size: 3rem; color: rgba(255,255,255,0.05); font-weight: 900; }

        @media (max-width: 768px) {
            .slide { padding: 50px 30px; }
            .nav-arrow { display: none; }
            .seq-num { right: 30px; font-size: 2rem; }
            .swipe-hint { display: flex !important; }
        }

        /* Swipe Hint Animation */
        .swipe-hint {
            position: fixed;
            bottom: 40px;
            right: 20px;
            color: var(--unor-gold);
            font-size: 0.8rem;
            font-weight: bold;
            z-index: 1500;
            display: none;
            align-items: center;
            gap: 5px;
            pointer-events: none;
            animation: swipeAnim 1.5s infinite ease-in-out;
            transition: opacity 0.5s;
        }
        @keyframes swipeAnim {
            0%, 100% { transform: translateX(0); opacity: 0.6; }
            50% { transform: translateX(-10px); opacity: 1; }
        }

        /* Print Button */
        .print-btn {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 2000;
            background: var(--unor-gold);
            color: var(--unor-blue);
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            font-family: 'Montserrat', sans-serif;
        }

        /* Slide Manager Styles */
        .manager-btn {
            position: fixed;
            top: 70px;
            left: 20px;
            z-index: 2000;
            background: var(--unor-blue);
            color: var(--unor-gold);
            border: 1px solid var(--unor-gold);
            padding: 10px 15px;
            border-radius: 5px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            font-family: 'Montserrat', sans-serif;
        }

        .modal { display: none; position: fixed; z-index: 4000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.8); }
        .modal-content { background-color: #fefefe; margin: 5% auto; padding: 20px; border: 1px solid #888; width: 90%; max-width: 600px; border-radius: 10px; color: #333; max-height: 90vh; overflow-y: auto; }
        .close { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
        .close:hover { color: black; }
        
        .slide-list-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 15px; margin-top: 20px; }
        .manager-card { background: #eee; padding: 10px; border-radius: 8px; transition: transform 0.2s; border: 2px solid transparent; display: flex; flex-direction: column; justify-content: space-between; min-height: 140px; }
        .manager-card:hover { transform: scale(1.05); border-color: var(--unor-blue); }
        .manager-card-content { cursor: pointer; flex-grow: 1; }
        .card-controls { display: flex; justify-content: space-between; margin-top: 10px; border-top: 1px solid #ccc; padding-top: 5px; }
        .card-controls button { background: none; border: none; cursor: pointer; font-size: 1.2rem; padding: 0 5px; color: #555; }
        .card-controls button:hover { color: var(--unor-blue); transform: scale(1.2); }
        .card-controls button:disabled { color: #ccc; cursor: default; transform: none; }
        .btn-delete:hover { color: #c0392b !important; }
        .add-slide-btn { display: flex; align-items: center; justify-content: center; background: white; border: 2px dashed #ccc; color: #888; font-weight: bold; cursor: pointer; min-height: 140px; border-radius: 8px; transition: all 0.2s; }
        .add-slide-btn:hover { border-color: var(--unor-blue); color: var(--unor-blue); background: #f0f8ff; }
        .manager-card h4 { margin: 0 0 5px 0; font-size: 0.9rem; color: var(--unor-blue); }
        .manager-card p { margin: 0; font-size: 0.7rem; color: #666; }

        .speakers-info { font-size: 0.9rem; color: var(--unor-gold); font-weight: bold; margin-bottom: 15px; font-style: italic; display: block; }
        /* Toggle UI Button */
        .toggle-btn {
            position: fixed;
            top: 120px;
            left: 20px;
            z-index: 2000;
            background: rgba(0, 0, 0, 0.5);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            transition: all 0.3s;
        }
        .toggle-btn:hover { background: rgba(0, 0, 0, 0.8); border-color: white; }

        /* Inline Edit Styles */
        .section { position: relative; }
        .section-controls {
            position: absolute;
            top: 10px;
            right: 10px;
            display: flex;
            gap: 5px;
            z-index: 10;
        }
        .inline-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: var(--unor-gold);
            cursor: pointer;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            transition: all 0.3s;
        }
        .inline-btn:hover { opacity: 1; background: rgba(255, 255, 255, 0.3); }
        .inline-btn.save-mode { background: var(--festive-green); color: white; opacity: 1; }
        .inline-btn.delete-mode:hover { background: #c0392b; color: white; }

        .slide-controls { margin-top: 20px; text-align: center; padding-bottom: 20px; }
        .btn-add-section {
            background: rgba(255, 255, 255, 0.05); border: 1px dashed var(--unor-gold); color: var(--unor-gold);
            padding: 8px 15px; border-radius: 20px; cursor: pointer; font-family: 'Montserrat', sans-serif; font-size: 0.8rem; transition: all 0.3s;
        }
        .btn-add-section:hover { background: rgba(255, 255, 255, 0.15); }

        .content[contenteditable="true"] {
            background: rgba(0, 0, 0, 0.3);
            padding: 10px;
            border-radius: 5px;
            outline: 2px solid var(--unor-gold);
            min-height: 50px;
        }

        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; font-size: 0.9rem; }
        .form-group input, .form-group textarea, .form-group select { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; font-family: inherit; }
        .form-group textarea { resize: vertical; min-height: 80px; }
        .section-edit-group { background: #f9f9f9; padding: 15px; margin-bottom: 15px; border: 1px solid #ddd; border-radius: 5px; position: relative; }
        
        /* WYSIWYG Styles */
        .wysiwyg-container { border: 1px solid #ccc; border-radius: 4px; overflow: hidden; background: white; }
        .wysiwyg-toolbar { background: #f1f1f1; border-bottom: 1px solid #ccc; padding: 5px; display: flex; gap: 5px; }
        .wysiwyg-toolbar button { background: white; border: 1px solid #ccc; cursor: pointer; padding: 5px 10px; font-weight: bold; border-radius: 3px; font-size: 14px; }
        .wysiwyg-toolbar button:hover { background: #e1e1e1; }
        .wysiwyg-content { padding: 10px; min-height: 80px; outline: none; font-family: inherit; color: #333; }

        .btn-remove-section { position: absolute; top: 10px; right: 10px; color: #c0392b; background: none; border: none; font-size: 1.2rem; cursor: pointer; }
        
        .modal-actions { text-align: right; margin-bottom: 20px; }
        .modal-actions button { padding: 8px 16px; margin-left: 10px; cursor: pointer; border-radius: 4px; border: none; font-weight: bold; }
        .btn-save { background: var(--festive-green); color: white; }
        .btn-cancel { background: #c0392b; color: white; }

        @media print {
            .print-btn, .manager-btn, .toggle-btn, .nav-arrow, .progress-nav, .modal, .section-controls, .slide-controls { display: none !important; }
            body, html { height: auto; overflow: visible; background: white; }
            .slider { display: block; height: auto; overflow: visible; width: 100%; }
            .slide {
                width: 100%; height: auto; page-break-inside: avoid; break-inside: avoid;
                border-bottom: 1px solid #ccc; margin-bottom: 20px; padding: 20px;
                color: black; background: white !important; flex: none; display: block;
            }
            .content, .header h2, .header p, .label, .dept-list { color: black !important; }
            .seq-num, .seq-num-top { color: #ddd !important; text-shadow: none; position: relative; top: auto; right: auto; left: auto; float: right; font-size: 1.5rem; background: none; padding: 0; }
            .section { background: none; border: 1px solid #eee; padding: 10px; }
            .bridge-text { color: #d35400 !important; } .thank-text { color: #27ae60 !important; }
        }
    </style>
</head>
<body>


<div class="nav-arrow prev" onclick="moveSlide(-1)">&#10094;</div>
<div class="nav-arrow next" onclick="moveSlide(1)">&#10095;</div>
<div class="swipe-hint">SWIPE &#10095;&#10095;</div>
<button class="print-btn" onclick="window.print()">&#128424; Print Script</button>
<button class="manager-btn" onclick="openSlideManager()">&#9881; Manage Slides</button>
<button class="toggle-btn" onclick="toggleUI()" title="Hide/Show Controls">&#128065;</button>

<!-- Modals -->
<div id="managerModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeModal('managerModal')">&times;</span>
        <h2>Slide Manager</h2>
        <div style="margin-bottom: 15px; text-align: right;">
            <button class="btn-save" onclick="exportJSON()">&#128229; Export JSON</button>
            <button class="btn-save" onclick="exportText()" style="background: #e67e22;">&#128196; Export Text</button>
            <button class="btn-save" onclick="document.getElementById('importFile').click()" style="background: #3498db;">&#128228; Import JSON</button>
        </div>
        <div id="slideList" class="slide-list-grid"></div>
    </div>
</div>
<input type="file" id="importFile" style="display: none;" accept=".json" onchange="importJSON(event)">

<div id="editModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeModal('editModal')">&times;</span>
        <h2>Edit Slide</h2>
        <div class="modal-actions">
            <button class="btn-save" onclick="saveSlide()">Save</button>
            <button class="btn-cancel" onclick="closeModal('editModal')">Cancel</button>
        </div>
        <div id="editForm"></div>
    </div>
</div>

<div id="statusModal" class="modal">
    <div class="modal-content" style="text-align: center; max-width: 400px;">
        <span class="close" onclick="closeModal('statusModal')">&times;</span>
        <h2 id="statusTitle" style="color: var(--unor-blue);"></h2>
        <p id="statusMessage"></p>
        <button class="btn-save" onclick="closeModal('statusModal')">OK</button>
    </div>
</div>

<div class="slider" id="slider">
    <!-- Content will be injected via JavaScript -->
</div>

<div class="progress-nav"><div class="progress-bar" id="progressBar"></div></div>

<script>
    const slider = document.getElementById('slider');
    const progressBar = document.getElementById('progressBar');

    // This listens specifically for the horizontal swipe
    slider.addEventListener('scroll', () => {
        const scrollLeft = slider.scrollLeft;
        const maxScroll = slider.scrollWidth - slider.clientWidth;
        
        if (maxScroll > 0) {
            // Calculate progress percentage
            const percentage = (scrollLeft / maxScroll) * 100;
            // Update the width of the gold bar
            progressBar.style.width = percentage + '%';
        }

        // Hide swipe hint once user starts scrolling
        const hint = document.querySelector('.swipe-hint');
        if (hint && scrollLeft > 50) hint.style.opacity = '0';
    });

    function moveSlide(direction) {
        slider.scrollBy({ left: direction * slider.clientWidth, behavior: 'smooth' });
    }

    // Firebase Configuration
    const firebaseConfig = {

    apiKey: "AIzaSyB-6OZBYnTJAQXHlDwmZ5G47OGSaY6zc4I",

    authDomain: "uno-r-xmas-script.firebaseapp.com",

    projectId: "uno-r-xmas-script",

    storageBucket: "uno-r-xmas-script.firebasestorage.app",

    messagingSenderId: "852772658090",

    appId: "1:852772658090:web:e1910235ee02c96f7c29d3"

    };


    // Initialize Firebase
    let db;
    try {
        firebase.initializeApp(firebaseConfig);
        db = firebase.firestore();
    } catch (e) {
        console.error("Firebase init error. Check config.", e);
    }

    let scriptData = [];
    const defaultScriptData = [
        {
            seqNum: "01",
            header: { title: "Welcome", subtitle: "Ready to Start" },
            sections: [
                { type: "intro-section", label: "Instruction", content: "No script loaded. Please import a JSON file or add slides." }
            ]
        }
    ];

    function showStatusModal(title, message) {
        document.getElementById('statusTitle').innerText = title;
        document.getElementById('statusMessage').innerText = message;
        document.getElementById('statusModal').style.display = 'block';
    }

    function loadFromFirebase() {
        if (!db) {
            console.warn("Firebase not configured. Using default data.");
            scriptData = JSON.parse(JSON.stringify(defaultScriptData));
            renderMainSlider();
            return;
        }

        let isConnected = false;

        db.collection("events").doc("xmas2025").onSnapshot((doc) => {
            if (!isConnected) {
                isConnected = true;
                showStatusModal("Success", "Firebase Connected Successfully!");
                setTimeout(() => closeModal('statusModal'), 2000);
            }
            if (doc.exists) {
                scriptData = doc.data().slides;
            } else {
                scriptData = JSON.parse(JSON.stringify(defaultScriptData));
                // Removed saveToFirebase() to prevent overwriting data on connection failure/offline
            }
            renderMainSlider();
            if(document.getElementById('managerModal').style.display === 'block') {
                openSlideManager();
            }
        }, (error) => {
            console.error("Firebase Error:", error);
            showStatusModal("Error", "Failed to connect: " + error.message);
            // Load default data locally only
            scriptData = JSON.parse(JSON.stringify(defaultScriptData));
            renderMainSlider();
        });
    }

    function saveToFirebase() {
        if (db) db.collection("events").doc("xmas2025").set({ slides: scriptData });
    }

    function renderMainSlider() {
        slider.innerHTML = scriptData.map((slide, slideIndex) => {
            const seqClass = slide.seqClass || "seq-num";
            const seqStyle = slide.seqStyle || "";
            const slideStyle = slide.style || "";
            
            let headerHTML = `<div class="header" style="position:relative;">`;
            headerHTML += `<div class="section-controls" style="top:0; right:0;">
                <button class="inline-btn" onclick="toggleHeaderEdit(${slideIndex}, this)">âœŽ</button>
            </div>`;
            headerHTML += `<h2>`;
            if (slide.header.badge) headerHTML += `<span class="vo-badge">${slide.header.badge}</span> `;
            headerHTML += `<span id="title-${slideIndex}" style="${slide.header.titleStyle || ''}">${slide.header.title}</span></h2>`;
            headerHTML += `<p id="subtitle-${slideIndex}" style="${slide.header.subtitleStyle || ''}">${slide.header.subtitle}</p></div>`;
            
            let speakersHTML = "";
            if (slide.speakers) {
                speakersHTML = `<div class="speakers-info" style="position:relative;">
                    <div class="section-controls" style="top:-5px; right:0;">
                        <button class="inline-btn" onclick="toggleSpeakerEdit(${slideIndex}, this)">âœŽ</button>
                    </div>
                    ðŸŽ¤ <span id="speakers-${slideIndex}">${slide.speakers}</span>
                </div>`;
            }

            let sectionsHTML = slide.sections.map((section, sectionIndex) => {
                const contentClass = section.contentClass || "";
                const deptListHTML = section.deptList ? `<div class="dept-list">${section.deptList}</div>` : "";
                return `
                <div class="section ${section.type || ''}" style="${section.style || ''}">
                    <div class="section-controls">
                        <button class="inline-btn" onclick="toggleInlineEdit(${slideIndex}, ${sectionIndex}, this)">âœŽ</button>
                        <button class="inline-btn delete-mode" onclick="deleteSectionInline(${slideIndex}, ${sectionIndex})">ðŸ—‘</button>
                    </div>
                    ${section.label ? `<span class="label" id="label-${slideIndex}-${sectionIndex}">${section.label}</span>` : ''}
                    <div class="content ${contentClass}" id="content-${slideIndex}-${sectionIndex}" style="${section.contentStyle || ''}">${section.content}</div>
                    ${deptListHTML}
                </div>`;
            }).join('');

            sectionsHTML += `<div class="slide-controls">
                <button class="btn-add-section" onclick="addSectionInline(${slideIndex})">+ Add Section</button>
            </div>`;

            return `
            <div class="slide" style="${slideStyle}">
                <div class="${seqClass}" style="${seqStyle}">${slide.seqNum}</div>
                ${headerHTML}
                ${speakersHTML}
                ${sectionsHTML}
            </div>`;
        }).join('');
    }

    function toggleInlineEdit(slideIndex, sectionIndex, btn) {
        const contentDiv = document.getElementById(`content-${slideIndex}-${sectionIndex}`);
        const labelSpan = document.getElementById(`label-${slideIndex}-${sectionIndex}`);
        const isEditing = contentDiv.isContentEditable;

        if (isEditing) {
            // Save
            scriptData[slideIndex].sections[sectionIndex].content = contentDiv.innerHTML;
            if (labelSpan) scriptData[slideIndex].sections[sectionIndex].label = labelSpan.innerText;
            saveToFirebase();
            contentDiv.contentEditable = "false";
            if (labelSpan) labelSpan.contentEditable = "false";
            btn.innerHTML = "âœŽ";
            btn.classList.remove('save-mode');
        } else {
            // Enable Edit
            contentDiv.contentEditable = "true";
            if (labelSpan) labelSpan.contentEditable = "true";
            contentDiv.focus();
            btn.innerHTML = "ðŸ’¾";
            btn.classList.add('save-mode');
        }
    }

    function toggleHeaderEdit(slideIndex, btn) {
        const titleEl = document.getElementById(`title-${slideIndex}`);
        const subtitleEl = document.getElementById(`subtitle-${slideIndex}`);
        const isEditing = titleEl.isContentEditable;

        if (isEditing) {
            scriptData[slideIndex].header.title = titleEl.innerText;
            scriptData[slideIndex].header.subtitle = subtitleEl.innerText;
            saveToFirebase();
            titleEl.contentEditable = "false";
            subtitleEl.contentEditable = "false";
            btn.innerHTML = "âœŽ";
            btn.classList.remove('save-mode');
        } else {
            titleEl.contentEditable = "true";
            subtitleEl.contentEditable = "true";
            titleEl.focus();
            btn.innerHTML = "ðŸ’¾";
            btn.classList.add('save-mode');
        }
    }

    function toggleSpeakerEdit(slideIndex, btn) {
        const speakerEl = document.getElementById(`speakers-${slideIndex}`);
        const isEditing = speakerEl.isContentEditable;

        if (isEditing) {
            scriptData[slideIndex].speakers = speakerEl.innerText;
            saveToFirebase();
            speakerEl.contentEditable = "false";
            btn.innerHTML = "âœŽ";
            btn.classList.remove('save-mode');
        } else {
            speakerEl.contentEditable = "true";
            speakerEl.focus();
            btn.innerHTML = "ðŸ’¾";
            btn.classList.add('save-mode');
        }
    }

    function deleteSectionInline(slideIndex, sectionIndex) {
        if(confirm("Delete this section?")) {
            scriptData[slideIndex].sections.splice(sectionIndex, 1);
            saveToFirebase();
            renderMainSlider();
        }
    }

    function addSectionInline(slideIndex) {
        scriptData[slideIndex].sections.push({
            type: "intro-section",
            label: "New Section",
            content: "Edit me..."
        });
        saveToFirebase();
        renderMainSlider();
    }

    // Initial Render
    loadFromFirebase();

    // Slide Manager Logic
    let currentEditIndex = -1;

    function openSlideManager() {
        const grid = document.getElementById('slideList');
        grid.innerHTML = '';
        scriptData.forEach((slide, index) => {
            const card = document.createElement('div');
            card.className = 'manager-card';
            card.innerHTML = `
                <div class="manager-card-content" onclick="openEditModal(${index})">
                    <h4>${slide.seqNum}</h4>
                    <p>${slide.header.title}</p>
                </div>
                <div class="card-controls">
                    <button onclick="moveSlideOrder(${index}, -1)" ${index === 0 ? 'disabled' : ''} title="Move Left">&#9664;</button>
                    <button class="btn-delete" onclick="deleteSlide(${index})" title="Delete">&#128465;</button>
                    <button onclick="moveSlideOrder(${index}, 1)" ${index === scriptData.length - 1 ? 'disabled' : ''} title="Move Right">&#9654;</button>
                </div>
            `;
            grid.appendChild(card);
        });
        
        const addBtn = document.createElement('div');
        addBtn.className = 'add-slide-btn';
        addBtn.innerHTML = '+ Add Slide';
        addBtn.onclick = addNewSlide;
        grid.appendChild(addBtn);

        document.getElementById('managerModal').style.display = 'block';
    }

    function moveSlideOrder(index, direction) {
        if (index + direction < 0 || index + direction >= scriptData.length) return;
        const temp = scriptData[index];
        scriptData[index] = scriptData[index + direction];
        scriptData[index + direction] = temp;
        saveToFirebase();
        renderMainSlider();
        openSlideManager();
    }

    function deleteSlide(index) {
        if(confirm('Delete this slide?')) {
            scriptData.splice(index, 1);
            saveToFirebase();
            renderMainSlider();
            openSlideManager();
        }
    }

    function addNewSlide() {
        scriptData.push({ seqNum: "NEW", style: "", header: { title: "New Slide", subtitle: "Subtitle" }, sections: [{ type: "intro-section", label: "Content", content: "Enter text here..." }] });
        saveToFirebase();
        renderMainSlider();
        openSlideManager();
    }

    function exportJSON() {
        const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(scriptData, null, 2));
        const downloadAnchorNode = document.createElement('a');
        downloadAnchorNode.setAttribute("href", dataStr);
        const date = new Date();
        const timestamp = date.getFullYear() + "-" + (date.getMonth() + 1).toString().padStart(2, '0') + "-" + date.getDate().toString().padStart(2, '0') + "_" + date.getHours().toString().padStart(2, '0') + "-" + date.getMinutes().toString().padStart(2, '0') + "-" + date.getSeconds().toString().padStart(2, '0');
        downloadAnchorNode.setAttribute("download", `${timestamp}_script_data.json`);
        document.body.appendChild(downloadAnchorNode);
        downloadAnchorNode.click();
        downloadAnchorNode.remove();
    }

    function exportText() {
        let textContent = "";
        
        scriptData.forEach(slide => {
            textContent += `=== SLIDE ${slide.seqNum} ===\n`;
            textContent += `TITLE: ${slide.header.title}\n`;
            if (slide.header.subtitle) textContent += `SUBTITLE: ${slide.header.subtitle}\n`;
            if (slide.speakers) textContent += `SPEAKERS: ${slide.speakers}\n`;
            textContent += `\n`;
            
            slide.sections.forEach(section => {
                if (section.label) textContent += `[${section.label}]\n`;
                
                // Strip HTML tags to get clean text
                const tempDiv = document.createElement("div");
                tempDiv.innerHTML = section.content;
                const plainText = tempDiv.innerText || tempDiv.textContent || "";
                
                textContent += `${plainText.trim()}\n\n`;
            });
            
            textContent += `--------------------------------------------------\n\n`;
        });

        const blob = new Blob([textContent], { type: 'text/plain' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        
        const date = new Date();
        const timestamp = date.getFullYear() + "-" + (date.getMonth() + 1).toString().padStart(2, '0') + "-" + date.getDate().toString().padStart(2, '0') + "_" + date.getHours().toString().padStart(2, '0') + "-" + date.getMinutes().toString().padStart(2, '0');
        a.download = `${timestamp}_script_readable.txt`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);
    }

    function importJSON(event) {
        const file = event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const json = JSON.parse(e.target.result);
                if (Array.isArray(json)) {
                    scriptData = json;
                    saveToFirebase();
                    renderMainSlider();
                    openSlideManager();
                    alert("Import successful!");
                } else {
                    alert("Invalid JSON format: Expected an array.");
                }
            } catch (err) {
                alert("Error parsing JSON: " + err.message);
            }
            event.target.value = ''; // Reset input
        };
        reader.readAsText(file);
    }

    function openEditModal(index) {
        currentEditIndex = index;
        const slide = scriptData[index];
        const form = document.getElementById('editForm');
        
        // Escape quotes to prevent syntax errors in template literal
        const safeTitle = slide.header.title.replace(/"/g, '&quot;');
        const safeSubtitle = slide.header.subtitle.replace(/"/g, '&quot;');
        const safeSpeakers = (slide.speakers || "").replace(/"/g, '&quot;');

        form.innerHTML = `
            <div class="form-group"><label>Title</label><input type="text" id="editTitle" value="${safeTitle}"></div>
            <div class="form-group"><label>Subtitle</label><input type="text" id="editSubtitle" value="${safeSubtitle}"></div>
            <div class="form-group"><label>Speakers/Hosts</label><input type="text" id="editSpeakers" value="${safeSpeakers}" placeholder="e.g. Erl, Rue"></div>
            <hr style="margin: 20px 0; border: 0; border-top: 1px solid #eee;">
            <div id="sectionsContainer"></div>
            <button type="button" class="add-slide-btn" style="min-height: 40px; margin-top: 10px; width: 100%;" onclick="addSectionToModal()">+ Add Section</button>
        `;

        const container = document.getElementById('sectionsContainer');
        slide.sections.forEach((section, sIndex) => {
            addSectionToModal(section);
        });

        document.getElementById('editModal').style.display = 'block';
    }

    function addSectionToModal(section = null) {
        const container = document.getElementById('sectionsContainer');
        const div = document.createElement('div');
        div.className = 'section-edit-group';
        
        const data = section || { type: 'intro-section', label: 'The Script', content: '' };
        
        const types = [
            { val: 'intro-section', txt: 'Intro (Blue)' },
            { val: 'bridge-section', txt: 'Bridge (Orange)' },
            { val: 'thank-section', txt: 'Thank You (Green)' },
            { val: 'section', txt: 'Generic' }
        ];
        
        const options = types.map(t => `<option value="${t.val}" ${data.type === t.val ? 'selected' : ''}>${t.txt}</option>`).join('');

        div.innerHTML = `
            <button type="button" class="btn-remove-section" onclick="this.parentElement.remove()" title="Remove Section">&#128465;</button>
            <div class="form-group">
                <label>Type</label>
                <select class="section-type-select">${options}</select>
            </div>
            <div class="form-group">
                <label>Label</label>
                <input type="text" class="section-label-input" value="${data.label || ''}">
            </div>
            <div class="form-group">
                <label>Content</label>
                <div class="wysiwyg-container">
                    <div class="wysiwyg-toolbar">
                        <button type="button" onmousedown="event.preventDefault(); document.execCommand('bold', false, null);" title="Bold">B</button>
                        <button type="button" onmousedown="event.preventDefault(); document.execCommand('italic', false, null);" title="Italic">I</button>
                        <button type="button" onmousedown="event.preventDefault(); document.execCommand('underline', false, null);" title="Underline">U</button>
                    </div>
                    <div class="wysiwyg-content section-content-input" contenteditable="true">${data.content || ''}</div>
                </div>
            </div>
            <div class="form-group">
                <label>Dept. List (Optional)</label>
                <input type="text" class="section-dept-input" value="${data.deptList || ''}">
            </div>
        `;
        container.appendChild(div);
    }

    function saveSlide() {
        if (currentEditIndex === -1) return;
        const slide = scriptData[currentEditIndex];
        slide.header.title = document.getElementById('editTitle').value;
        slide.header.subtitle = document.getElementById('editSubtitle').value;
        slide.speakers = document.getElementById('editSpeakers').value;
        
        // Rebuild sections array from DOM
        slide.sections = [];
        const sectionGroups = document.querySelectorAll('.section-edit-group');
        sectionGroups.forEach(group => {
            const type = group.querySelector('.section-type-select').value;
            const label = group.querySelector('.section-label-input').value;
            const content = group.querySelector('.section-content-input').innerHTML;
            const deptList = group.querySelector('.section-dept-input').value;
            
            let contentClass = "";
            if (type === 'bridge-section') contentClass = "bridge-text";
            if (type === 'thank-section') contentClass = "thank-text";

            const newSection = {
                type: type,
                label: label,
                content: content,
                contentClass: contentClass
            };
            if(deptList) newSection.deptList = deptList;
            
            slide.sections.push(newSection);
        });

        saveToFirebase();
        renderMainSlider();
        closeModal('editModal');
        openSlideManager();
    }

    function toggleUI() {
        const printBtn = document.querySelector('.print-btn');
        const managerBtn = document.querySelector('.manager-btn');
        const sectionControls = document.querySelectorAll('.section-controls');
        const slideControls = document.querySelectorAll('.slide-controls');
        const isHidden = printBtn.style.display === 'none';
        printBtn.style.display = isHidden ? '' : 'none';
        managerBtn.style.display = isHidden ? '' : 'none';
        sectionControls.forEach(el => el.style.display = isHidden ? '' : 'none');
        slideControls.forEach(el => el.style.display = isHidden ? '' : 'none');
    }

    function closeModal(id) { document.getElementById(id).style.display = 'none'; }
    window.onclick = function(e) { if (e.target.classList.contains('modal')) e.target.style.display = "none"; }
</script>
</body>
</html>